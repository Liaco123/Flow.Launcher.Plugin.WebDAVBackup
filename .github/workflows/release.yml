name: Build And Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build -c Release --no-restore

      - name: Package plugin zip
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $manifest = Get-Content "plugin.json" -Raw | ConvertFrom-Json
          $version = $manifest.Version
          $tfm = "net6.0-windows7.0"
          $packageRoot = "dist/Flow.Launcher.Plugin.WebDAVBackup"
          $buildOutput = "bin/Release/$tfm"

          if (Test-Path $packageRoot) {
            Remove-Item $packageRoot -Recurse -Force
          }
          New-Item -ItemType Directory -Path $packageRoot -Force | Out-Null
          New-Item -ItemType Directory -Path "$packageRoot/Images" -Force | Out-Null

          Copy-Item "plugin.json" "$packageRoot/plugin.json" -Force
          Copy-Item "Images/app.png" "$packageRoot/Images/app.png" -Force
          Copy-Item "$buildOutput/Flow.Launcher.Plugin.WebDAVBackup.dll" "$packageRoot/Flow.Launcher.Plugin.WebDAVBackup.dll" -Force

          if (Test-Path "$buildOutput/Flow.Launcher.Plugin.WebDAVBackup.deps.json") {
            Copy-Item "$buildOutput/Flow.Launcher.Plugin.WebDAVBackup.deps.json" "$packageRoot/Flow.Launcher.Plugin.WebDAVBackup.deps.json" -Force
          }

          if (Test-Path "$buildOutput/Flow.Launcher.Plugin.WebDAVBackup.pdb") {
            Copy-Item "$buildOutput/Flow.Launcher.Plugin.WebDAVBackup.pdb" "$packageRoot/Flow.Launcher.Plugin.WebDAVBackup.pdb" -Force
          }

          $zipPath = "dist/Flow.Launcher.Plugin.WebDAVBackup-$version.zip"
          if (Test-Path $zipPath) {
            Remove-Item $zipPath -Force
          }
          Compress-Archive -Path "$packageRoot/*" -DestinationPath $zipPath

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-package
          path: dist/Flow.Launcher.Plugin.WebDAVBackup-*.zip

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Download packaged artifact
        uses: actions/download-artifact@v4
        with:
          name: release-package
          path: dist

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
